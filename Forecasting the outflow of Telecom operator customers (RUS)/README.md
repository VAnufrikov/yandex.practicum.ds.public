# Forecasting the outflow of Telecom operator customers (RUS)
*** 

### Задача
***

Оператор связи `Ниединогоразрыва.ком` столкнулся с проблемой прогнозирования оттока клиентов и была выдвинута гипотеза 
о том что если клиент захочет уйти от провайдера, то ему будут предложены промокоды и специальные условия для удержания клиента в компании.

Оператор собрал данные по услугам:
- Телефонной стационарной связи
- Пользования услугами интернет по двум каналам DSL и Fiber optic
- Стриминговое телевиденья
- Каталог фильмов доступные для аренды и покупки

И дополнительные услуги:
- Антивирус
- Блокировка небезопасных сайтов
- Выделенная линия технической поддержки

### Описание данных
***

Данные состоят из файлов, полученных из разных источников:

- `contract.csv` — информация о договоре;
- `personal.csv` — персональные данные клиента;
- `internet.csv` — информация об интернет-услугах;
- `phone.csv` — информация об услугах телефонии.

Столбец `customerID` содержит код клиента, информация о договорах актуальна на 1 февраля 2020.

### Описание полей
***

- `BeginDate` - дата начала пользования услугами
- `EndDate` - дата окончания пользования услугами
- `Type` - тип договора
- `PaperlessBilling` - факт выставления счета на электронную почту
- `PaymentMetod` - способ оплаты
- `MonthlyCharges` - ежемесячные траты на услуги
- `TotalCharges` - всего потрачено на услуги
- `Dependents` - наличие иждивенцев
- `SeniorCitizen` - наличие пенсионного статуса по возрасту
- `Partner` - наличие супруга
- `MultipleLines` - наличие возможность ведения параллельных линий во время звонка

В данной работе мы сосредоточимся на задаче бинарной классификации для внутреннего сервиса, где на вход будет подаваться id клиента и его индивидуальный набор услуг, а на выходе будет ответ от сервиса удет ли клиент в ближайшее время или нет по средствам ответа True или False.

>После созвона с тимлидом проекта было принято решение разработать MVP проект для оператора связи, согласно этому плану действий.

Анализ df
- [x] EDA через ProfileReport
- [x] Создаем df для хранения результатов обучения несколькими моделями по метрикам F1, AUC-ROC и Accuracy

Предобработка данных
- [x] Переименовать столбцы df привести к нижнему регистру
- [x] Заполнить все пустые значения отдельной категорией no_data для текстовых значений или 0 для числовых
- [x] Изменить тип данных у df к которому больше советуют значения
- [x] Придумать новые фичи на основе имеющихся данных (дата, срок жизни и тд)
- [x]  Выбрать столбца только с самой высокой корреляцией с полем таргета
- [x] Закодировать категориальные признаки

Обучение модели через Pipline
- [x] Разбиение df на обучающую и тестовую выборку 75-25
- [x] Масштабируем признаки
- [x] Подбираем гиперпарметры через RandomizedSearchCV
- [x] Выполняем кросс валидацию
- [x] Записываем результаты обучения

Тестирование MVP
- [x] Тестируем выбранную модель на тестовой выборке
- [x] Сравниваем выбранную модель с константной моделью (DummyClassifier)
- [x] Строим графики ROC кривой и смотрим отчет о категоризации (confusion_matrix, classification_report)
- [x] Делаем выводы по обученной модели и значимость выбранных признаков

**************
### Набор данных

Нам предоставили набор исторических данных о клиентах провайдера за несколько лет. Клиентам доступны разные виды расчета за услуги(ежемесячная оплата, контракт на 1 или 2 года).

- `contract.csv` — информация о договоре с клиентом
- `personal.csv` — персональные данные клиента по контракту с оператором связи
- `internet.csv` — информация об интернет-услугах потребляемые клиентом
- `phone.csv` — информация об услугах телефонии потребляемые клиентом

В данных файлах `customerID` является кодом клиента, в поле EndDate содержится информация ушел ли клиент из компании или нет, данная выгрузка из база является актуальной на 1 февраля 2020 года.

>Для первичного EDA анализа был выбран ProfileReport который позволяет посмотреть на данные со всех сторон, в том числе матрицу корреляции признаков в нашей модели.

<a href="https://ibb.co/5xVgCvw"><img src="https://i.ibb.co/5xVgCvw/image.png" alt="image" border="0"></a>
**************
### Особенности и обработка

Первоначально при анализе данных был выявлен паттерн, что в части данных которые отвечают за услуги компании были обнаружены пропуски в данных, после консультации с тимлидом проекта было принято решение заполнить эти пропуски в данных отсутвием данной услуги у клиента на момент выгрузки данных. Так же в полях с категориальной информацией мы заполнили пропуски категорией No_data.

После заполнения пропусков в данных мы создали поле таргета из поля end_contract, а так же создали новые фичи такие, как сколько дней, месяцев, лет прошло с момента подключения провайдера. Сколько клиент в месяц генирировал количесво невозвратной суммы, количесво подключенных доп услуг  и других...

Далее мы предусмотрели тот факт что в случае внеднения заказчиком нового поля или услуги данный MVP проект не потерял в качестве и использовал все новые поля которые будут добавлены в проект.

При кодировании данных мы столкнулись с проблемой серьезного расширения DF за счет кодирования категориальных признаков техникой OHE, однако проанализировав альтернативы мы остановились на Target Encoder который кодирует средним значением целевой метки по данному значению категориального признака, в следсвии чего это нам позволило не так сильно наш увеличить DF.

> Интересно то что в процессе обучения модели и выявления самых влияющих фичей, мы попытались оставить в итоговом df только те поля которые сильно коррелируют с полем таргета. Однако снижение размерности df не дало нам сильного прироста метрик ROC-AUC и F1 в этом задании.

Итоговая матрица корреляции признаков в df получилась такая
<a href="https://ibb.co/Jq6Gn3y"><img src="https://i.ibb.co/Jq6Gn3y/image.png" alt="image" border="0"></a>
**************
### Модели и методы

В данном проекте мы пробовали применить несколько моделей машинного обучения, простую с точки зрения интерпретируемости модели
- LogisticRegression

Ансамблевые модели
- RandomForestClassifier
- DecisionTreeClassifier

Модели бустинга
- GradientBoostingClassifier
- CatBoostClassifier

При обучении моделей мы подготовили несколько функций для хранения результатов и подбора гиперпараметров через `RandomizedSearchCV`(выбрали его ввиду поиска оптимальных параметров) с обязательно кроссвалидацией результата. 
Так как это было важно выполнить по требованиям тимлида плюс контроля переобучения моделей.
**************
### Результаты

По результатам подбора гиперпараметров победила модель гадиентного бустинга, однако при повторном ее обучении уже с использованием PipeLine данная модель показала на тестовом df более плохие результаты чем CatBoostClassifier. Поэтому для MVP был выбран именно CatBoostClassifier
**************
### Вывод

По результатам работы мы подготовили MVP модель, которая отвечает требования оператора связи и помогает решить задачу бинарной класификации уйдет или клиент или нет. 

После внеденеия данного MVP проекта оператор `Ниединогоразрыва.ком` стал более уверенно чествовать себя на рынке, а так же это позволило ему удержать ключевых клиентов. 

Которые были готовы перейти к конкурентам в ближайшее время и предоставить им сочные условия дальнейшего сотрудничества.
**************

### Используемые библиотеки
***

- `numpy`
- `pandas`
- `datetime`
- `pandas_profiling`
- `sklearn`
- `matplotlib`
- `catboost`